# CustomWords 数据结构升级说明

## 概述

本次升级完全移除了旧版本兼容字段，实现了设计文档中的新数据结构。对于在 officialwordlibraries 找到且用户未修改的数据，customwords 表中**不再存储**例句、释义、发音等详细数据。

## 主要变更

### 1. 数据库模型变更

#### CustomWord 模型 (`src/server/models/CustomWord.ts`)
- ❌ 移除字段：`trans`, `usphone`, `ukphone`, `notation`
- ✅ 保留字段：`sourceType`, `officialWordId`, `userData`, `isUserModified`, `isEmpty`

#### 新的数据存储逻辑
```typescript
// 官方数据（用户未修改）
{
  sourceType: 'official',
  officialWordId: 'official-word-id',
  userData: undefined,
  isUserModified: false,
  isEmpty: false
}

// 用户自定义数据
{
  sourceType: 'user_custom',
  officialWordId: undefined,
  userData: {
    usphone: '...',
    ukphone: '...',
    sentences: [...],
    detailed_translations: [...]
  },
  isUserModified: true,
  isEmpty: false
}

// 空白数据
{
  sourceType: 'empty',
  officialWordId: undefined,
  userData: undefined,
  isUserModified: false,
  isEmpty: true
}
```

### 2. 服务层变更

#### DictionaryUploadService (`src/server/services/DictionaryUploadService.ts`)
- 移除 `CustomWordData` 接口中的旧字段
- 改进 `processLegacyWordUpload` 方法，将旧格式数据转换为新的 `userData` 格式

#### WordQueryService (`src/server/services/WordQueryService.ts`)
- 修改 `mergeWordData` 方法，移除对旧字段的处理
- 确保动态从官方词库获取数据

### 3. 前端接口变更

#### ICustomWord 接口 (`src/utils/db/customDictionary.ts`)
- 移除旧版本字段：`trans`, `usphone`, `ukphone`, `notation`
- 更新相关函数：`createCustomWord`, `convertCustomWordToWord`, `convertExcelDataToCustomWords`

### 4. 新增脚本

#### 数据清理脚本 (`src/server/scripts/clean-custom-words.ts`)
```bash
npm run clean-custom-words
```
- 清理所有现有的 CustomWord 数据
- 为新数据结构提供干净的起点

#### 测试脚本 (`src/server/scripts/test-new-structure.ts`)
```bash
npm run test-new-structure
```
- 测试新的数据上传和查询流程
- 验证数据结构的正确性

## 数据存储优势

### 1. 存储效率
- **官方数据**：只存储关联ID，不重复存储详细信息
- **用户数据**：仅在用户修改时才存储在 `userData` 字段中
- **空间节省**：大幅减少数据冗余

### 2. 数据一致性
- 官方数据始终保持最新，无需同步更新
- 用户修改的数据独立存储，不会被覆盖

### 3. 查询性能
- 批量查询官方数据，减少数据库访问
- 动态合并数据，确保实时性

## 升级步骤

### 1. 清理现有数据
```bash
npm run clean-custom-words
```

### 2. 测试新结构
```bash
npm run test-new-structure
```

### 3. 验证功能
- 上传词典测试
- 查询词典测试
- 编辑单词测试

## 注意事项

1. **数据清理不可逆**：运行清理脚本前请确保备份重要数据
2. **兼容性**：旧版本的上传格式仍然支持，会自动转换为新格式
3. **性能**：新结构在大词典场景下性能更优

## 问题排查

如果遇到问题，请检查：
1. 数据库连接是否正常
2. 官方词库数据是否存在
3. `officialWordId` 字段是否正确设置
4. `userData` 字段格式是否正确

## 总结

本次升级实现了设计文档中的核心目标：
- ✅ 数据分离：官方数据与用户数据完全分离
- ✅ 存储优化：避免数据冗余，提高存储效率
- ✅ 查询优化：动态合并数据，确保实时性
- ✅ 用户可控：用户可以编辑任何单词的任何字段

**回答原始问题**：对于在 officialwordlibraries 找到且用户没有修改的数据，customwords 表中**不会存储**单词的例句、释义、发音等详细数据，只存储关联信息（officialWordId），查询时动态从官方词库获取。
