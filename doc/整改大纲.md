### 整改大纲（一次“大版本同步架构升级”）

## 1. 目标与范围
- 目标
  - 统一数据模型与命名，收敛同步协议，消除外键脆弱点与索引缺失引发的性能/一致性问题。
  - 确保数据在“前端 IndexedDB ↔ 服务端 MongoDB”间严格同构、可回放、可观测、可回滚。
- 范围
  - 六个数据集：`wordReviewRecords`、`reviewHistories`、`wordRecords`、`chapterRecords`、`familiarWords`、`reviewRecords`
  - 前端：Dexie v10 升级、同步层、版本哨兵
  - 后端：Mongoose Schema 对齐、同步控制器
  - 安全与运维：鉴权、观测、灰度与回滚

## 2. 统一规范（全局）
- 命名与时间类型
  - 统一驼峰：`syncStatus`、`lastModified`、`createTime` 等
  - 前端：时间戳 `number`；后端：`Date`
  - 同步边界：单点转换（前端→后端：number→Date；后端→前端：Date→number）
- 标识与外键
  - 主键幂等：`uuid`
  - 软删除：`isDeleted`
  - 修改追踪：`lastModified:number`（客户端）、`clientModifiedAt:Date`（服务端）
  - 外键关系：改造为 `parentUuid`（替代通过 `word` 的弱关联）
- 版本治理
  - `APP_DATA_VERSION` 本地哨兵（不匹配→清库重建或迁移）
  - 服务端“版本拒写”（旧客户端拒绝写入）

## 3. 前端改造（Dexie v10 升级）
- 通用
  - 新建 v10 stores；`upgrade()` 中补全默认值、清理重复/脏数据；修复 v9 缺字段
  - 引入本地 `userId`（便于多账号本地隔离与清理）
  - 写入侧统一 upsert 策略，减少重复
- 各数据集变更
  - wordReviewRecords
    - 字段：补齐 `userId/intervalSequence/totalReviews/reviewHistory/consecutiveCorrect/sourceDicts/preferredDict/firstSeenAt/lastReviewedAt/todayPracticeCount/nextReviewAt/isGraduated/syncStatus/lastModified`
    - 索引：`&uuid`、`&word`、`nextReviewAt`、`lastReviewedAt`、`currentIntervalIndex`、`isGraduated`、`preferredDict`、`lastModified`
    - 取消“以 word 回填 uuid”，仅以 `uuid` 幂等
  - reviewHistories
    - 新增外键：`parentUuid`（指向 `wordReviewRecords.uuid`）
    - 索引：`[parentUuid+reviewedAt]`、`[dict+reviewedAt]`、`[word+reviewedAt]`
    - 历史只新增（append-only），不更新
  - wordRecords
    - `performanceHistory` 增加 `entryUuid`（去重键）
    - 索引补充：`lastPracticedAt`、`[dict+lastPracticedAt]`
  - chapterRecords
    - 字段统一：`createTime`（替换/映射 `timeStamp`），其余保持
    - 索引：`[dict+chapter+createTime]` 或 `createTime`
  - familiarWords
    - 保持 `&uuid`，保证写入侧用 `[dict+word]` 去重（如可行，用 `&[dict+word]` 唯一索引）
  - reviewRecords
    - 统一 `createTime`（替换 `timeStamp`）
    - 索引：`createTime`
- 同步层（前端）
  - 统一“幂等 upsert by uuid + isDeleted”
  - `reviewHistories` 以 `parentUuid` 关联，不再用 `word` 反查
  - `wordRecords.performanceHistory` 合并按 `entryUuid`（或 `(timeStamp, featureHash)`）去重
  - 先下后上（下载→再上传），批处理、错误分类、统计指标保留

## 4. 后端改造（Mongoose Schema 与同步控制器）
- Schema 对齐
  - 字段命名/类型与前端一致（含 `sync_status/last_modified/clientModifiedAt/isDeleted`）
  - 建立必需唯一/复合索引：
    - `wordReviewRecords`: `(userId, word)` 唯一；`(userId, nextReviewAt)`、`(userId, lastReviewedAt)`、`(userId, updatedAt)`
    - `reviewHistories`: `(userId, reviewedAt)`、`(userId, word, reviewedAt)`、`(userId, sessionId)`、`(userId, reviewResult, reviewedAt)`
    - `wordRecords`: `(userId, dict, word)` 唯一；`(userId, lastPracticedAt)`、`(userId, updatedAt)`
    - `chapterRecords`: `(userId, dict, chapter)`、`(userId, updatedAt)`、`createTime`
    - `familiarWords`: `(userId, dict, word)` 唯一；`(userId, updatedAt)`
    - `reviewRecords`: `(userId, createTime)`、`(userId, updatedAt)`
- 同步控制器
  - 单点类型转换（Date↔number）、统一幂等 upsert、append-only history
  - 外键：基于 `parentUuid` 转 `ObjectId`；失败则跳过并记录
  - 冲突：`lastModified`/`updatedAt` 优先；history 不冲突（只新增）
  - 版本拒写：校验请求头 `appDataVersion`

## 5. 迁移与数据策略
- 历史不重要（推荐简化）
  - 前端：`APP_DATA_VERSION` 不匹配 → 清空 IndexedDB，按 v10 重建
  - 后端：清空六表（保留 `User` 与官方词库），或保留结构、清掉用户数据
- 历史需保留（备选）
  - v10 升级脚本：补默认值、补 `parentUuid`、生成 `entryUuid`、类型迁移、重建索引
  - 对不可修复的脏数据做隔离/标记

## 6. 安全与权限
- token 从 `localStorage` 迁至 HttpOnly Cookie（或保留但加强 CSP/SRI 与输入净化）
- 所有写入带 `userId` 校验；同步接口最小权限校验、速率限制
- 审计：记录关键集合的写操作指标/异常

## 7. 观测与质量保障
- 指标：同步耗时、失败率、批量 upsert 规模、索引命中、重复清理数、SchemaDiff 告警
- 校验：启动自检（Dexie 版本、索引状态、字段一致性）；数据质量定期巡检作业

## 8. 发布与灰度/回滚
- 顺序：先上后端（兼容新协议）→ 再发前端（启用 v10/哨兵）
- 灰度：小流量验证指标与告警阈值
- 回滚：后端保留旧接口分支；前端回滚即触发拒写并提示升级

## 9. 交付物清单
- `v10` Dexie stores 定义与升级脚本
- 六表 Mongoose Schema 对齐与索引脚本
- 同步控制器合并策略与错误分类
- `APP_DATA_VERSION` 哨兵与前端清库逻辑
- 线上运维脚本（清库/迁移/索引重建/审计）
- 文档：统一数据规范、同步协议、运维手册、回滚手册
- 验收用例与自动化校验脚本（基本 CRUD、同步、并发与冲突、索引验证）

## 10. 里程碑与验收
- M1 统一规范定稿（模型/协议/索引/版本策略）
- M2 前端 v10 与同步层改造完成（含哨兵）
- M3 后端 Schema/控制器/索引完成
- M4 联调与灰度上线
- M5 验收：无 SchemaDiff、无错绑、同步成功率≥99%、主要页面查询 P95 达标

---
