### 全局基线已确认
- 时间：API 统一毫秒 number；服务端持久化为 Date；仅在同步边界做 number↔Date 转换（不做时钟偏移校准）。
- 跨词典聚合：`wordReviewRecords` 以 `(userId, word)` 唯一（同语种词典共享复习进度）；保留 `sourceDicts`、`preferredDict`。
- 外键：`reviewHistories` 使用 `parentUuid`（指向 `wordReviewRecords.uuid`）为唯一关联锚点；`word/dict` 仅作冗余查询字段。
- 版本治理与安全：启用 `x-app-data-version` 拒写；Token 迁移至 HttpOnly Cookie。
- Dexie 不引入 `userId` 字段。

### 命名与类型（统一规范）
- 一律驼峰：`syncStatus / lastModified / createTime / firstSeenAt / lastPracticedAt / lastReviewedAt / isDeleted / clientModifiedAt`
- 时间含义：
  - 前端：`lastModified:number(ms)`（冲突比较）；其他时间字段均为 number(ms)
  - 服务端：上面对应的字段为 Date；保留 `createdAt/updatedAt`（Mongoose）

---

## 各数据集统一清单（字段/索引/同步要点）

### 1) wordReviewRecords（跨词典聚合的主记录）
- 唯一键
  - 服务端：`(userId, word)` 唯一
  - 客户端：`uuid` 幂等（不再用 word 回填 uuid）
- 字段（FE 类型 → BE 类型）
  - `uuid: string → string`
  - `word: string → string`
  - `intervalSequence: number[] → number[]`
  - `currentIntervalIndex: number → number`
  - `nextReviewAt: number → Date`
  - `totalReviews: number → number`
  - `isGraduated: boolean → boolean`
  - `reviewHistory?: IReviewHistoryEntry[] → 可选（如保留）`
  - `consecutiveCorrect?: number → number`
  - `lastReviewedAt?: number → Date`
  - `todayPracticeCount: number → number`
  - `lastPracticedAt: number → Date`
  - `sourceDicts: string[] → string[]`
  - `preferredDict: string → string`
  - `firstSeenAt: number → Date`
  - `syncStatus: "synced"|"localNew"|"localModified"|"localDeleted" → string`
  - `lastModified: number → number`
  - `isDeleted?: boolean → boolean`
  - `clientModifiedAt(仅BE): Date`
- Dexie v10 stores（建议）
```ts
wordReviewRecords:
  "++id,&uuid,&word,nextReviewAt,lastReviewedAt,currentIntervalIndex,isGraduated,preferredDict,lastModified"
```
- 服务端索引
  - 唯一：(userId, word)
  - 二级：(userId, nextReviewAt)、(userId, lastReviewedAt)、(userId, updatedAt)
- 同步要点
  - 幂等以 uuid；删除用 isDeleted
  - 不再通过 word 回填 uuid
  - 时间仅边界转换

### 2) reviewHistories（复习历史，append-only）
- 关联
  - 外键锚点：`parentUuid = wordReviewRecords.uuid`
  - 冗余：`word`、`dict` 保留用于查询，不参与关联
- 字段（FE → BE）
  - `uuid: string → string`
  - `parentUuid: string → 用于解析成 ObjectId 外键`
  - `word: string → string`
  - `dict: string → string`
  - `reviewedAt: number → Date`
  - `reviewResult: "correct"|"incorrect" → string`
  - `responseTime: number → number`
  - `intervalProgressBefore/After: number → number`
  - `intervalIndexBefore/After: number → number`
  - `reviewType: "scheduled"|"manual"|"practice_triggered" → string`
  - `sessionId?: string → string`
  - `syncStatus: string`
  - `lastModified: number → number`
  - `isDeleted?: boolean → boolean`
- Dexie v10 stores（建议）
```ts
reviewHistories:
  "++id,&uuid,parentUuid,word,dict,reviewedAt,lastModified,[parentUuid+reviewedAt],[word+reviewedAt],[dict+reviewedAt]"
```
- 服务端索引
  - (userId, reviewedAt)、(userId, word, reviewedAt)、(userId, sessionId)、(userId, reviewResult, reviewedAt)
- 同步要点
  - 严格 append-only（新增/软删，不更新）
  - 上传用 parentUuid 解析外键；下载用 parentUuid 映射本地

### 3) wordRecords（练习表现历史，非复习）
- 唯一键
  - 服务端：(userId, dict, word)
  - 客户端：uuid 幂等
- 关键字段（FE → BE）
  - `uuid, dict, word`
  - `performanceHistory: [{ entryUuid: string; timeStamp:number; chapter:number|null; timing:number[]; wrongCount:number; mistakes:Record<number,string[]> }]`
  - `firstSeenAt?: number → Date`
  - `lastPracticedAt?: number → Date`
  - `syncStatus, lastModified, isDeleted?`
- Dexie v10 stores（建议）
```ts
wordRecords:
  "++id,&uuid,&[dict+word],lastPracticedAt,lastModified"
```
- 服务端索引
  - 唯一：(userId, dict, word)
  - 二级：(userId, lastPracticedAt)、(userId, updatedAt)
- 同步要点
  - performanceHistory 合并按 entryUuid 去重（缺失时用 (timeStamp, featureHash) 回退）
  - mistakes 字段缺省补空对象

### 4) chapterRecords（章节练习汇总）
- 唯一键
  - 无唯一；按用户/章节/时间聚合
- 字段（FE → BE）
  - `uuid: string`
  - `dict: string`
  - `chapter: number|null`
  - `createTime: number → Date`（统一命名替代 timeStamp）
  - `time, correctCount, wrongCount, wordCount, correctWordIndexes:number[], wordNumber, wordRecordIds:number[]`
  - `syncStatus, lastModified, isDeleted?`
- Dexie v10 stores（建议）
```ts
chapterRecords:
  "++id,&uuid,dict,chapter,createTime,lastModified,[dict+chapter+createTime]"
```
- 服务端索引
  - (userId, dict, chapter)、(userId, updatedAt)、createTime
- 同步要点
  - 仅边界时间转换；命名统一 createTime

### 5) familiarWords（熟词标记）
- 唯一键
  - 服务端：(userId, dict, word) 唯一
  - 客户端：uuid 幂等（写入侧严格 upsert `[dict+word]`）
- 字段（FE → BE）
  - `uuid, dict, word, isFamiliar:boolean, syncStatus, lastModified, isDeleted?`
- Dexie v10 stores（建议）
```ts
familiarWords:
  "++id,&uuid,dict,word,lastModified,[dict+word]"
```
- 服务端索引
  - 唯一：(userId, dict, word)
  - 二级：(userId, updatedAt)

### 6) reviewRecords（阶段性复习列表）
- 唯一键
  - 无
- 字段（FE → BE）
  - `uuid: string`
  - `dict: string`
  - `index: number`
  - `createTime: number → Date`（统一替代 timeStamp）
  - `isFinished: boolean`
  - `words: any[]`（建议后续约束结构）
  - `syncStatus, lastModified, isDeleted?`
- Dexie v10 stores（建议）
```ts
reviewRecords:
  "++id,&uuid,dict,createTime,lastModified"
```
- 服务端索引
  - (userId, createTime)、(userId, updatedAt)

---

## 同步协议（通用）
- 先下后上；所有变更按 `uuid` 幂等 upsert；删除为 `isDeleted=true`
- 冲突：比较 `lastModified(ms)` vs `clientModifiedAt.getTime()`，较新者胜
- 类型转换：仅在边界（API）进行毫秒↔Date
- 版本：请求头 `x-app-data-version` 校验；不满足最小版本拒写

---

## 验收要点（后续细化用）
- 命名统一（无 snake_case）
- API 时间字段均为毫秒 number；服务端全为 Date
- `reviewHistories` 外键全以 parentUuid 成功解析；word/dict 仅用于查询
- Dexie v10 stores 与索引生效，无 SchemaDiff 告警
- `(userId, word)` 聚合在服务端唯一；客户端不再依赖 word 回填 uuid

