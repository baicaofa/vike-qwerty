### 执行步骤清单（Dexie v10 升级，按 PR 粒度）

#### PR-1 数据库版本与 Schema 基座
- 变更点
  - `src/utils/db/index.ts`：将 `version` 升至 10，新增 v10 stores 声明（六表）。
  - 引入“升级自检/统计”工具（本地 `upgradeStatsV10`）。
  - `checkAndUpgradeDatabase()` 期望版本改为 10；新增 `x-app-data-version` 请求头注入（常量，如 `v10`）。
- 验收
  - 构建/运行无错误；不触发 `upgrade()` 时应用正常启动。
- 观测指标
  - 启动自检日志：版本=10；stores 校验通过；SchemaDiff=0。
- 回退点
  - 还原期望版本到 9；注释 v10 stores 与升级调用。

#### PR-2 清空两表：wordReviewRecords、reviewHistories
- 变更点
  - `src/utils/db/index.ts` v10 `upgrade(tx)`：`tx.table('wordReviewRecords').clear()`、`tx.table('reviewHistories').clear()`。
  - 移除前端“word 回填 uuid”逻辑；前端严格以 `parentUuid` 关联（只在“新数据”生效）。
- 验收
  - 升级后两表本地记录数=0；页面无异常。
- 观测指标
  - 清空计数（两表删除行数）；升级用时。
- 回退点
  - 移除 `clear()`；保留 v10 空升级；或回退到 v9。

#### PR-3 wordRecords 在线迁移（entryUuid + 去重 + 兜底）
- 变更点
  - `src/utils/db/record.ts`：`IPerformanceEntry` 增加 `entryUuid: string`。
  - `src/utils/db/index.ts` v10 `upgrade(tx)`：
    - 分批处理 wordRecords（500~1000/批）：
      - 去重：按 `uuid`、按 `[dict+word]`（保留 `lastModified` 最新）。
      - 遍历 `performanceHistory`：`entry.mistakes ||= {}`；`entry.entryUuid ||= generateUUID()`。
      - 兜底时间：`firstSeenAt = min(entry.timeStamp) || now`；`lastPracticedAt = max(entry.timeStamp) || now`。
    - stores：`"++id,&uuid,&[dict+word],dict,word,lastPracticedAt,lastModified"`.
  - 写入路径：`useSaveWordRecord()`/`WordRecord.addPerformanceEntry()` 创建 entry 时生成 `entryUuid`，兜底 `mistakes`。
- 验收
  - 无重复 `uuid`、`[dict+word]`；所有 entry 具备 `entryUuid` 和 `mistakes`；页面正常。
- 观测指标
  - 去重数量、补 `entryUuid` 数量、补 `mistakes` 数量、兜底时间字段数量、迁移总耗时。
- 回退点
  - 关闭 v10 升级逻辑；保留类型变更但不在运行路径使用 `entryUuid`（风险小）。

#### PR-4 chapterRecords 迁移（timeStamp → createTime）
- 变更点
  - v10 `upgrade(tx)`：将旧 `timeStamp:number` 重命名/复制为 `createTime:number`；字段缺失兜底；索引加 `[dict+chapter+createTime]` 或 `createTime`。
- 验收
  - 全量记录存在 `createTime`；历史/统计页正常。
- 观测指标
  - 重命名/兜底记录数；迁移耗时。
- 回退点
  - 暂不迁移，保留旧字段（功能可用但不统一）。

#### PR-5 familiarWords 迁移（去重 + upsert 约束）
- 变更点
  - v10 `upgrade(tx)`：按 `[dict+word]` 去重（保留 `lastModified` 最新）；stores 加 `[dict+word]`、`lastModified`。
  - 运行时写入：统一“先查后写”确保 `[dict+word]` 唯一。
- 验收
  - 无重复 `[dict+word]`；熟词标记切换稳定。
- 观测指标
  - 去重条数；写入 upsert 命中率。
- 回退点
  - 仅保留运行时 upsert，跳过历史去重。

#### PR-6 reviewRecords 迁移（timeStamp → createTime）
- 变更点
  - v10 `upgrade(tx)`：将 `timeStamp` 迁移为 `createTime`；stores 添加 `createTime`、`lastModified` 索引。
- 验收
  - 复习列表正常；创建/完成流程无异常。
- 观测指标
  - 迁移的字段数；耗时。
- 回退点
  - 暂不迁移字段，后续统一。

#### PR-7 同步层前端改造对齐（仅前端）
- 变更点
  - `src/services/syncService.ts`：
    - 上传：继续兜底 `performanceHistory[*].mistakes ||= {}`；不再上传 `reviewHistories.wordReviewRecordId`（两表本地已清空）。
    - 下载：保持按 `uuid` 幂等 upsert；`reviewHistories` 未来改造为 `parentUuid`（本 PR 不产生数据）。
  - 所有请求统一带 `x-app-data-version: v10`。
- 验收
  - 同步成功率稳定；无异常字段（如旧 `wordReviewRecordId:number`）。
- 观测指标
  - 本次同步“创建/更新/删除/错误”计数；失败重试次数；平均耗时。
- 回退点
  - 保留旧逻辑分支；移除 `x-app-data-version` 注入。

#### PR-8 启动自检与故障兜底
- 变更点
  - 自检：Dexie 版本=10、stores/索引存在性、关键字段检查（wordRecords 的 entryUuid/mistakes 抽样校验）。
  - 失败兜底：提示“重建本地数据”（仅本地清库，不动 `lastSyncTimestamp`）。
- 验收
  - 自检通过；手动模拟异常可触发重建流程并成功恢复。
- 观测指标
  - 自检耗时、失败次数、触发重建次数。
- 回退点
  - 关闭自检与重建提示（保守模式）。

#### PR-9 灰度与开关控制
- 变更点
  - 灰度开关：`V10_UPGRADE_ENABLED`（远端开关或本地配置）；在 `upgrade()` 最前判定是否执行迁移。
  - 指标上报/日志标签包含开关状态。
- 验收
  - 在小流量开启时，无新增错误；指标在阈值内。
- 观测指标
  - 开启比例、升级成功率、异常率。
- 回退点
  - 关闭开关，停止执行 v10 升级；保留 v10 stores（对已升级用户不回退结构）。

#### PR-10 文档与工具
- 变更点
  - `doc/整改大纲.md`、新增 `doc/前端-Dexie-v10-升级指南.md`：字段清单、迁移流程、指标、回滚。
  - 开发调试工具：导出 `upgradeStatsV10`、快速检测页面（仅 dev）。
- 验收
  - 文档完整；调试页可用。
- 观测指标
  - 无（文档型）。
- 回退点
  - 无代码影响。

---

### 衔接说明
- 以上每个 PR 均可独立合并与回退；建议顺序执行。
- PR-2 清空两表仅本地生效，不触发“云端删除”；同步逻辑保持增量拉取，旧云端数据不会回灌本地。
- PR-3 是核心（wordRecords 的条目幂等与结构稳态），优先保证质量与观测。
- 灰度策略：先合并 PR-1/2/3 到预发布环境，小比例用户开启 PR-9 开关，观察指标后再全量开启。