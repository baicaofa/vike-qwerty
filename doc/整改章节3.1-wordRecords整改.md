### 目标与范围
- 目标：在不清空 `wordRecords` 的前提下完成 Dexie v10 在线升级，构建稳定、可幂等、可合并的练习记录结构，并优化索引与查询性能。
- 范围：仅覆盖表 `wordRecords` 的前端数据结构、写入路径、Dexie v10 升级迁移、同步边界适配；不改服务端存储模型与协议（仅提出对接要点）。

### 一、现状复盘（关键逻辑与字段职责）
- 存储位置：IndexedDB/Dexie（本地）；MongoDB（云端）。
- 唯一性：
  - FE：`uuid` 作为幂等主键；自然键 `[dict+word]` 期望唯一（现依赖逻辑去重）。
  - BE：`(userId, dict, word)` 唯一。
- 写入流程（前端当前行为）：
  - 新建记录：构造 `WordRecord`，生成 `uuid`，若有首条表现则写入到 `performanceHistory`。
  - 追加表现：创建 `performanceEntry`（timeStamp、chapter、timing、wrongCount、mistakes），push 到 `performanceHistory`，更新 `lastPracticedAt`、`last_modified`，`synced→local_modified`。
  - 无错时的 `mistakes`：保存时兜底为 `{}`（已实现）；上传前也会再次兜底为 `{}`（已实现）。
- 同步（摘取要点）：
  - 上传：以 `uuid` 幂等 upsert；`performanceHistory` 的每条 entry 若缺 `mistakes` 则补 `{}`。
  - 服务端合并：当前以 `timeStamp.getTime()` 作为条目键进行覆盖式去重（有同毫秒冲突风险）。
  - 下载：服务端 `Date` → FE `number(ms)`，前端 `bulkPut` 标记 `synced`。

### 二、v10 目标模型与索引（FE）
- 关键改动
  - 为每个 `performanceEntry` 增加 `entryUuid: string`，作为条目级幂等与合并锚点；`timeStamp` 仅用于排序。
  - `mistakes` 永远存在（无错时为 `{}`）；避免出现 `undefined/null`。
- 字段规范（FE → BE）
  - `uuid: string → string`
  - `dict: string → string`
  - `word: string → string`
  - `performanceHistory: PerformanceEntry[]`（FE `timeStamp:number`；BE `timeStamp:Date`）
    - `PerformanceEntry = { entryUuid: string; timeStamp:number; chapter:number|null; timing:number[]; wrongCount:number; mistakes:Record<number, string[]> }`
  - `firstSeenAt:number → Date`（由最早 entry 推导）
  - `lastPracticedAt:number → Date`（由最新 entry 推导）
  - `syncStatus: "synced"|"localNew"|"localModified"|"localDeleted" → string`
  - `lastModified:number → number`
  - `isDeleted?: boolean → boolean`
- Dexie v10 stores（建议最终字符串）
```ts
wordRecords:
  "++id,&uuid,&[dict+word],dict,word,lastPracticedAt,lastModified"
```
- 说明
  - `&uuid`、`&[dict+word]`：本地幂等与自然键唯一（若 Dexie 版本不支持复合唯一，则用写入侧严格 upsert 实现）。
  - `lastPracticedAt`：用于最近练习排序与分页。
  - `lastModified`：用于待同步筛选。

### 三、运行时改造（v10 生效后）
- 创建表现 entry 的必做项
  - 生成 `entryUuid = generateUUID()`
  - `mistakes = mistakes || {}`（无错时为空对象）
  - 追加后：按 `timeStamp` 升序排序；更新 `lastPracticedAt = 最新 entry.timeStamp`；`lastModified = Date.now()`；若原 `syncStatus === "synced"`，改为 `localModified`。
- 幂等写入
  - upsert by `uuid`；
  - 保证 `[dict+word]` 唯一：写入前先 `where({dict, word}).first()` 检查并合并（如 Dexie 不支持复合唯一）。
- 性能保护（可选）
  - `performanceHistory` 长度上限（如 200 条）：超出则做“老记录压缩/聚合”（仅 FE 存摘要，BE 可选同策略）。

### 四、v10 在线迁移方案（version(10).upgrade）
- 原则
  - 不清表；不改 `lastModified/syncStatus`，避免触发无意义全量上传。
  - 分批迁移（每批 500~1000 条）以避免主线程长阻塞。
- 步骤
  1) 去重（记录级）
     - 按 `uuid` 分组：保留 `lastModified` 最大者，删除其余。
     - 按 `[dict+word]` 分组：保留 `lastModified` 最大者；若保留项缺 `uuid`，生成新的 `uuid` 并写回。
  2) 结构修复（条目级）
     - `performanceHistory` 非数组 → 置为 `[]`。
     - 遍历每条 entry：
       - `mistakes` 缺失 → 置 `{}`。
       - `entryUuid` 缺失 → 置 `generateUUID()`。
  3) 时间兜底
     - `firstSeenAt` 缺失 → 取最早 `entry.timeStamp`，无 entry 时取 `Date.now()`。
     - `lastPracticedAt` 缺失 → 取最晚 `entry.timeStamp`，无 entry 时取 `Date.now()`。
  4) 清理遗留顶层字段
     - 若仍存在旧顶层字段（`timeStamp/chapter/timing/wrongCount/mistakes`）则忽略/删除，确保结构收敛。
  5) 索引验证
     - 确保 `&uuid`、`&[dict+word]`（或写入侧 upsert）、`lastPracticedAt`、`lastModified` 可用。
- 失败兜底
  - 捕获异常并记录样本；若迁移批出现异常次数超阈，提示用户“重建本地数据”（仅本地库重置，并不触发云端删除）。

伪代码（仅示意）
```ts
this.version(10).stores({
  wordRecords: "++id,&uuid,&[dict+word],dict,word,lastPracticedAt,lastModified",
})
.upgrade(async (tx) => {
  const table = tx.table("wordRecords");
  // 1) 去重 by uuid / [dict+word]
  // 2) 结构修复：entry.mistakes ||= {}; entry.entryUuid ||= generateUUID()
  // 3) 时间兜底：firstSeenAt/lastPracticedAt
  // 4) 清理旧顶层字段
  // 5) 不改动 lastModified/syncStatus
});
```

### 五、同步边界与合并（对接要点）
- FE→BE：时间仅做毫秒 number → Date 的边界转换；条目携带 `entryUuid`。
- BE 合并建议（不要求立刻改动，但作为对接协议）：
  - 合并 `performanceHistory` 时优先用 `entryUuid` 去重合并；
  - 对于旧数据（缺 `entryUuid`），回退用 `(timeStamp + featureHash)`，`featureHash = hash(chapter, wrongCount, timing.length)`；
  - 其他字段冲突仍按 `lastModified(ms)` vs `clientModifiedAt.getTime()` 新者胜。
- BE→FE：若服务端返回历史条目仍有少数缺 `entryUuid`，FE 首次入库时自动补齐并本地标记，不必触发上传。

### 六、观测、验收与回滚
- 观测指标
  - 迁移耗时（总/批）、去重条数、补默认值条数、异常样本数；
  - 运行期：最近练习列表与搜索 P95；同步上传条数是否稳定（无异常暴涨）。
- 验收标准（wordRecords 专属）
  - 无重复 `uuid`、无重复 `[dict+word]`；
  - 所有条目具备 `entryUuid` 与 `mistakes`；
  - `firstSeenAt`、`lastPracticedAt` 不为空；
  - 主要页面与查询无 SchemaDiff 警告，性能无回退；
  - 同步往返后服务端合并不产生重复条目。
- 回滚
  - 若 v10 迁移失败严重：提示用户“重建本地数据”（清库后按 v10 stores 初始化）；不动云端数据与 lastSyncTimestamp。
  - 迁移逻辑保持幂等：重复执行不会损坏数据。

### 七、任务拆解（可执行）
- 任务 1：类型更新
  - `IPerformanceEntry` 增加 `entryUuid: string`；在写入路径生成 `entryUuid` 与 `mistakes` 兜底。
- 任务 2：Dexie v10 stores 与升级
  - 定义 v10 stores 字符串；实现 `upgrade()` 的批处理：去重、结构修复、时间兜底、清理遗留字段。
- 任务 3：写入侧幂等与唯一性
  - 写入前 `where({dict, word}).first()` 合并，保证 `[dict+word]` 唯一（如 Dexie 不支持复合唯一）。
- 任务 4：同步对接与自检
  - 保持现有同步契约；启动自检：索引/结构检查；
  - 日志与观测埋点：迁移用时、修复量、异常。

