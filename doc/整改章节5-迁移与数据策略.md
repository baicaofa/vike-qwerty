### 迁移与数据策略（细化可执行方案）

## 1. 目标与原则
- 统一数据契约：API 毫秒时间（number），DB Date；仅边界转换。
- 幂等与去重：记录级 `uuid` 幂等；自然键（服务端）强约束；条目级（performanceEntry）`entryUuid` 去重。
- 零损/最小损升级：不停止服务、支持灰度；失败可回退。
- 本地清理与在线迁移并存：两表本地清空，其它表在线迁移。

## 2. 数据分组与策略矩阵
- 本地直接清空（仅本地，不影响云端）
  - wordReviewRecords：清空
  - reviewHistories：清空（改为 parentUuid 关联后重建）
- 本地在线迁移（Dexie v10 upgrade）
  - wordRecords：保留，迁移补 `entryUuid`、`mistakes`、去重、索引完善
  - chapterRecords：`timeStamp → createTime`，补默认值
  - familiarWords：按 `[dict+word]` 去重，写入侧 upsert
  - reviewRecords：`timeStamp → createTime`
- 云端迁移（Mongoose）
  - Schema 与索引先行（已在后端改造章节定义），兼容新旧字段命名；不批量改数，仅在同步合并时“带修复”。

## 3. 升级顺序与窗口（推荐无停机）
1) 预置索引（Mongo 后台构建）  
2) 上线后端（支持 v10 协议，兼容旧字段；开放版本拒写中间件但先处于“观测模式”）  
3) 小流量灰度前端（带 Dexie v10 & 自检 & 本地两表清空）  
4) 放量前端；开启“强制版本拒写”  
5) 维持一段观察期（软删清理/孤儿统计作业启用）

## 4. 前端执行清单（Dexie v10）
- v10 stores 生效（所有表）  
- upgrade() 中执行：
  - 清空：`wordReviewRecords.clear()`、`reviewHistories.clear()`
  - wordRecords：
    - 按 `uuid`、`[dict+word]` 去重（保留 `lastModified` 新者）
    - `performanceHistory[*]`：`mistakes ||= {}`；`entryUuid ||= generateUUID()`
    - `firstSeenAt=min(timeStamp)`、`lastPracticedAt=max(timeStamp)` 补齐
  - chapterRecords：`timeStamp → createTime`、数组/数值兜底
  - familiarWords：按 `[dict+word]` 去重，保留新者
  - reviewRecords：`timeStamp → createTime`
- 运行时约束：
  - 新增 performanceEntry 必带 `entryUuid`；`mistakes` 恒为对象
  - 禁止“word 回填 uuid”；所有写入 upsert by `uuid`；familiarWords 写入侧严格 upsert `[dict+word]`
- 自检与兜底：
  - 版本=10、索引存在、字段完整（抽样）；失败→提示“重建本地数据”（仅本地清库，保留 lastSyncTimestamp）

## 5. 后端执行清单（Mongoose + 同步控制器）
- Schema 对齐：  
  - wordRecords.PerformanceEntry 增 `entryUuid`（必填）、`mistakes` 默认 `{}`  
  - reviewHistories 引入 `parentUuid`（冗余存储可选），强制以 `wordReviewRecordId` 作为外键落库  
  - 所有集合统一 `syncStatus/lastModified/clientModifiedAt/isDeleted`
- 同步控制器：
  - 入站：校验 `x-app-data-version >= v10`；毫秒→Date；`entryUuid` 必须存在；`parentUuid` 必须存在
  - 合并：
    - wordRecords：条目以 `entryUuid` 去重（缺失回退 `timeStamp+featureHash`），其他字段“新者胜”
    - wordReviewRecords：`(userId, word)` upsert；`sourceDicts` 做并集
    - reviewHistories：append-only；解析 `parentUuid → ObjectId`，无主键则跳过并审计
  - 出站：Date→毫秒；reviewHistories 回传 `parentUuid`，隐藏 ObjectId
- 版本拒写：开启 `MIN_APP_DATA_VERSION='v10'`；旧版本拒写（只读）
- Cookie 鉴权：HttpOnly；过渡期兼容 Bearer

## 6. 数据校验与回填策略
- 字段默认值矩阵（示例）
  - wordRecords.performanceEntry：`mistakes={}`、`entryUuid=uuid()`、`chapter=null`、`timing=[]`（非法→空）
  - 时间类：`firstSeenAt/lastPracticedAt` 无历史→`now()`
  - familiarWords：缺 `isFamiliar`→`false`
  - chapterRecords：计数类缺失→`0`；数组类缺失→`[]`
- 回退键（服务端条目合并）：`entryUuid || (timeStamp + featureHash)`，`featureHash=hash(chapter,wrongCount,timing.length)`

## 7. 回滚策略
- 配置开关：
  - 后端：`SYNC_PROTOCOL_V10_ENABLED`（关闭则降级旧合并，保留读写）
  - 前端：`V10_UPGRADE_ENABLED`（关闭则不执行 v10 升级；存量已升用户不回退结构）
- 本地重建：
  - 自检失败/迁移异常→提示“重建本地数据”（清 IndexedDB，按 v10 重建）
- 服务端回滚：
  - 暂停版本拒写（允许旧端写入），保留日志；控制器回退旧路径

## 8. 指标与告警（迁移期强烈建议）
- 迁移与修复指标（前端本地统计或上报）
  - 去重条数、补 `entryUuid/mistakes` 数量、字段兜底数量、迁移耗时
- 同步指标（服务端）
  - 成功率、平均耗时、冲突解决次数（client/server 胜）、外键失败率、版本拒写率
  - wordRecords：条目合并数、去重数（entryUuid/回退键）
  - reviewHistories：`parentUuid` 解析失败计数
- 告警阈值
  - 同步错误率 > 2%  
  - 外键解析失败率 > 0.1%  
  - 版本拒写率异常波动（回归）

## 9. 风险清单与缓解
- 本地清空两表后，云端仍保留旧数据：增量同步不会回灌（lastSyncTimestamp 抑制）。若需彻底抛弃旧云端，可服务端 30 天后做清理。
- 条目级时间戳碰撞：已引入 `entryUuid` 根除；旧数据按回退键去重。
- 旧客户端写入污染：版本拒写 + 日志审计；必要时短期关闭写入。
- 迁移耗时与卡顿：批处理（500–1000/批）+ UI 进度提示 + yield 控制。

## 10. 验收清单
- 结构：前端 v10 索引与字段齐备；后端 Schema/索引可用。
- wordRecords：无重复 `uuid`/`[dict+word]`；所有条目具备 `entryUuid/mistakes`；查询 P95 稳定。
- reviewHistories：仅 parentUuid 关联；append-only；外键失败率 < 0.1%。
- 同步：成功率 ≥ 99%；冲突解决正常；无 SchemaDiff/字段兼容报错。
- 版本治理：旧端被拒写且提示正确；Cookie 鉴权生效。

## 11. 里程碑（含可观测检查点）
- M1：后端 Schema/索引上线（检查索引状态、写流量正常）
- M2：后端控制器合并上线（观测冲突/外键失败/成功率）
- M3：小流量前端 v10（观测迁移修复量与耗时）
- M4：开启版本拒写（观测拒写率、旧端访问峰值）
- M5：全量前端；稳定运行 1–2 周（监控与脚本巡检）
- M6：收尾：软删清理、孤儿历史报告为 0；文档与回滚手册归档
