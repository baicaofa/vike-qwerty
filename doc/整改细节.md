
### 总体说明
- 本次整改对“本地 IndexedDB 结构、部分字段命名、同步契约”有影响。以下按表逐一列出：哪些受影响、不受影响、需要调整、可清理（含涉及文件/模块）。

---

## wordRecords（练习表现）

- 受影响
  - 类型与写入路径：`src/utils/db/record.ts`（`IPerformanceEntry`）、`src/utils/db/index.ts`（`useSaveWordRecord()`、`WordRecord.addPerformanceEntry()`）
  - 查询/统计：`src/components/DonateCard/hooks/useWordStats.ts`、`src/pages/Analysis/hooks/useWordStats.ts`、`src/pages/gallery/hooks/useErrorWords.ts`
  - 同步：`src/services/syncService.ts`（上传时对 `performanceHistory[*].mistakes` 兜底逻辑已存在）
  - 服务端：`src/server/controllers/syncController.ts`（合并逻辑需要按 entryUuid 去重）
- 不受影响
  - UI 展示依旧从本地拉取；时间仍用毫秒数（边界转换在后端）
- 需要调整
  - 为每个 `performanceEntry` 新增 `entryUuid`（创建时生成，迁移时补齐）
  - 确保 `mistakes` 始终为 `{}`（无错也设空对象）
  - 去除任何“用 timeStamp 作为唯一去重键”的假设（服务端已改为优先 entryUuid）
  - 索引与去重：本地写入侧保证 `[dict+word]` 唯一（先查后写）
- 可清理
  - 旧顶层遗留字段使用处（若有）：`timeStamp/chapter/timing/wrongCount/mistakes` 顶层字段相关逻辑
  - 客户端“基于 timeStamp 去重”的容错代码（若存在）

---

## reviewHistories（复习历史，append-only，本地清空）

- 受影响
  - 页面/查询：`src/pages/review/history/+Page.tsx`
  - 复习/调度：`src/utils/spaced-repetition/scheduleGenerator.ts`、`src/utils/spaced-repetition/index.ts`、`src/hooks/useSpacedRepetition.ts`
  - 同步：`src/services/syncService.ts`（原本有将 `wordReviewRecordId:number` 转成 `uuid` 的上传改造）
  - 服务端：`src/server/controllers/syncController.ts`（外键解析改为 `parentUuid→ObjectId`）
- 不受影响
  - 历史展示 UI 可以为空态；新数据按新协议重建
- 需要调整
  - 切换“外键关联”为 `parentUuid`（不再用 `word` 反查主键，不再上传 `wordReviewRecordId:number`）
  - 上传路径移除“通过 `word` 查 `wordReviewRecord` 再改 ID”的特判
  - 下载路径回填 `parentUuid`，前端用 `parentUuid→本地 uuid→本地 id` 建立关联；失败进入待重放队列
- 可清理
  - 任何“`word` 回填主键/ID”的路径与兼容分支
  - 本地 `wordReviewRecordId:number` 直接上传的旧代码

---

## wordReviewRecords（跨词典聚合，本地清空）

- 受影响
  - 间隔调度：`src/utils/spaced-repetition/scheduleGenerator.ts`、`src/utils/reviewRounds.ts`
  - 复习页：`src/pages/review/**`、`src/hooks/useSpacedRepetition.ts`
  - 数据类及定义：`src/utils/db/wordReviewRecord.ts`
  - 服务端模型/控制器：`src/server/models/WordReviewRecord.ts`、`src/server/controllers/syncController.ts`
- 不受影响
  - 新练习产生后会重新构建复习主记录；UI 可为空态
- 需要调整
  - 明确“跨词典聚合”语义：同一用户同一 `word` 只保留一条主记录；`sourceDicts` 并集合并、`preferredDict` 合法化
  - 去除“用 word 回填 uuid”的逻辑
- 可清理
  - 任何依赖“按词典拆分复习主记录”的残留分支
  - 旧的 uuid 推断/回填逻辑

---

## chapterRecords（章节练习汇总，字段更名）

- 受影响
  - 类型/数据：`src/utils/db/record.ts`（`IChapterRecord` 定义里有 `timeStamp`）、`src/utils/db/index.ts`（存储章节记录）
  - 统计与视图：`src/pages/gallery/hooks/useChapterStats.ts`、`src/components/DonateCard/hooks/useWordStats.ts`
  - 服务端模型：`src/server/models/ChapterRecord.ts`（当前采用 `timeStamp: Date`，后端需对齐为 `createTime` 或边界映射）
- 不受影响
  - 大多数 UI 逻辑（只要字段名统一映射即可）
- 需要调整
  - 将顶层 `timeStamp` 统一为 `createTime`（前端 Dexie v10 升级时完成，调用方改字段名）
  - 查询/排序/聚合使用 `createTime` 字段
  - 服务端接受旧字段名时在边界做兼容（若历史客户端短期存在）
- 可清理
  - 任何直接引用 `timeStamp` 的老代码（全部迁移到 `createTime`）

---

## familiarWords（熟词标记）

- 受影响
  - 页面：`src/pages/familiar/+Page.tsx`
  - 数据定义：`src/utils/db/record.ts`
  - 同步：`src/services/syncService.ts`（已有去重 `[dict+word]` 的上传特判）
  - 服务端模型/控制器：`src/server/models/FamiliarWord.ts`、`src/server/controllers/syncController.ts`
- 不受影响
  - UI 行为（标注/取消）与同步语义不变
- 需要调整
  - 写入侧严格 upsert `[dict+word]`（本地保证唯一，避免多条）
  - 若 Dexie 不支持复合唯一，继续保持“先查后写”的幂等写入策略
- 可清理
  - 多余的本地去重补丁（若写入侧 upsert 做到位）

---

## reviewRecords（阶段性复习列表，字段更名）

- 受影响
  - 存取：`src/utils/db/record.ts`（`IReviewRecord`）、`src/utils/db/review-record.ts`（如存在）、`src/store/reviewInfoAtom.ts`
  - 服务端模型：`src/server/models/ReviewRecord.ts`（当前为 `createTime: Date`，前端需统一到 `createTime`）
- 不受影响
  - 基本使用方式（创建、推进 index、完成标记）不变
- 需要调整
  - 将 `timeStamp` 统一重命名为 `createTime`
  - 前端查询、排序与上传字段名对齐
- 可清理
  - 所有对 `timeStamp` 的直接引用

---

## 跨表/通用影响

- 同步层 `src/services/syncService.ts`
  - 保留：wordRecords 上传前对 `performanceHistory[*].mistakes` 的兜底
  - 移除：reviewHistories 上传前将本地 `wordReviewRecordId:number` 转换为服务端 uuid 的逻辑
  - 维持：先下后上策略、以 `uuid` 幂等 upsert、软删 `isDeleted`
- 后端 `src/server/controllers/syncController.ts`
  - wordRecords：合并策略从“基于 timeStamp”改为“优先基于 entryUuid，回退 timeStamp+featureHash”
  - reviewHistories：只接受 `parentUuid` 关联；append-only
  - 出站：统一 Date→毫秒；`reviewHistories` 回传 `parentUuid`，隐藏 ObjectId
- 安全/治理
  - Cookie 鉴权改造：客户端无需处理 token，服务端读取 HttpOnly Cookie
  - 版本拒写：旧端写入会被拒绝；前端收到后引导升级

---

## 每表变更的“最小改动点清单”

- wordRecords
  - [改] `IPerformanceEntry` 增 `entryUuid`；创建/追加时生成
  - [改] 本地写入兜底 `mistakes = {}`；去除基于 `timeStamp` 的唯一假设
  - [查] 统计/页面是否依赖旧顶层字段，统一使用 `performanceHistory`
- reviewHistories
  - [删] 上传时的 `word→uuid` 回填逻辑
  - [加] 使用 `parentUuid` 作为外键；下载重放队列
- wordReviewRecords
  - [删] `word→uuid` 回填逻辑
  - [核] 依赖此表的调度/复习逻辑能在空态下工作
- chapterRecords
  - [改] 所有引用 `timeStamp` 的地方替换为 `createTime`
- familiarWords
  - [改] 写入侧严格 upsert `[dict+word]`
- reviewRecords
  - [改] 所有引用 `timeStamp` 的地方替换为 `createTime`

---

- 若需要，我可以把上述每个改动点进一步映射到具体函数/行号清单（逐文件），并给出“验证用例列表（页面/接口/同步）”，便于直接创建任务卡和验收。