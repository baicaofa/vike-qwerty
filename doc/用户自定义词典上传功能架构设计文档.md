# 用户自定义词典上传功能架构设计文档

## 项目概述

**项目名称：** Keybr（vike-qwerty）  
**功能模块：** 用户自定义上传词典  
**技术栈：** Vike + React + TypeScript + Tailwind CSS + Jotai  
**当前状态：** 已实现 90%以上功能，本文档为优化和扩展指南

## 功能价值与目标

### 核心价值

- **个性化学习：** 用户可根据学习需求创建专属词库
- **灵活性提升：** 支持专业领域词汇、特定考试词汇等
- **用户粘性：** 通过自定义内容增强用户与平台连接
- **场景扩展：** 从标准词库学习扩展到自定义内容学习

### 功能目标

1. 支持 Excel 格式词典文件上传和解析
2. 提供词典预览、校验、导入和编辑功能
3. 实现个人词库的私有化管理
4. 与现有打字练习系统无缝集成

## 技术架构设计

### 1. 前端架构

#### 1.1 路由与页面结构

```
src/pages/gallery/
├── +Page.tsx                    # 主页面，包含"我的词典"标签
├── LanguageTabSwitcher.tsx      # 标签切换器
├── context.ts                   # 上传弹窗状态管理
└── components/
    ├── UploadDictionaryModal.tsx    # 上传弹窗主组件
    ├── CustomDictionaryList.tsx     # 词典列表组件
    └── UploadWordEditModal.tsx      # 词条编辑组件
```

#### 1.2 组件设计模式

- **Modal 组件模式：** 避免额外路由跳转，提升用户体验
- **分步骤流程：** 上传 → 预览 → 处理 → 完成
- **响应式设计：** 支持桌面端和移动端

#### 1.3 懒加载策略

```typescript
// 推荐的懒加载实现
const ExcelParser = lazy(() => import("@/utils/excelParser"));
const UploadModal = lazy(() => import("./components/UploadDictionaryModal"));

// 动态导入大型库
const loadXlsxLibrary = () => import("xlsx");
```

### 2. 状态管理架构

#### 2.1 全局状态（Jotai）

```typescript
// src/store/customDictionary.ts
export const customDictionariesAtom = atom<ICustomDictionary[]>([]);
export const customDictionariesLoadingAtom = atom<boolean>(false);
export const currentCustomDictIdAtom = atomWithStorage<string | null>(
  "currentCustomDictId",
  null
);

// 上传状态管理
export const uploadStateAtom = atomWithStorage("uploadState", {
  recentUploads: [],
  preferences: {
    autoEnrichment: true,
    defaultCategory: "我的词库",
  },
});
```

#### 2.2 页面级状态

```typescript
// 上传弹窗状态
interface UploadModalState {
  step: 'upload' | 'preview' | 'processing';
  file: File | null;
  parsedWords: ICustomWord[];
  dictionaryInfo: Partial<ICustomDictionary>;
  errors: string[];
  progress: number;+
  }
```

### 3. 数据模型设计

#### 3.1 增强的自定义词条模型

```typescript
interface EnhancedCustomWord extends ICustomWord {
  // 基础字段
  id: string;
  dictId: string;
  name: string;
  index: number;

  // 数据来源
  sourceType: "official" | "user_custom" | "empty";
  officialWordId?: string;

  // 用户数据
  userData?: {
    usphone: string;
    ukphone: string;
    sentences: ISentence[];
    detailed_translations: IDetailedTranslation[];
  };

  // 状态标识
  isUserModified: boolean;
  isEmpty: boolean;
  createdAt: number;
  updatedAt: number;
}
```

#### 3.2 词典 Schema 设计

```typescript
interface UserDictionarySchema {
  version: string; // 版本控制
  metadata: {
    name: string;
    description: string;
    category: string;
    tags: string[];
    language: string;
    createdAt: number;
    updatedAt: number;
  };
  words: EnhancedCustomWord[];
  settings: {
    defaultPronunciation: "us" | "uk";
    autoEnrichment: boolean;
    learningMode: string;
  };
  analytics?: {
    totalWords: number;
    masteredWords: number;
    averageAccuracy: number;
    totalPracticeTime: number;
  };
}
```

## 文件处理与解析

### 1. Excel 解析策略

#### 1.1 客户端解析（当前实现）

**优势：**

- 减轻服务器负担
- 即时反馈用户体验
- 支持离线预览

**实现方案：**

```typescript
// src/utils/excelParser.ts
export async function parseExcelFile(file: File): Promise<ExcelParseResult> {
  // 使用SheetJS/xlsx库解析
  const data = await readFileAsArrayBuffer(file);
  const workbook = read(data, { type: "array" });

  // 验证和转换数据
  const { words, errors } = validateAndConvertData(jsonData);

  return {
    success: errors.length === 0,
    data: words,
    errors: errors.length > 0 ? errors : undefined,
    totalRows: jsonData.length,
    validRows: words.length,
  };
}
```

#### 1.2 Web Worker 优化（建议实现）

```typescript
// public/workers/excel-parser.js
self.onmessage = async function (e) {
  const { file } = e.data;

  try {
    // 在Worker中执行解析
    const result = await parseExcelInWorker(file);
    self.postMessage({ success: true, data: result });
  } catch (error) {
    self.postMessage({ success: false, error: error.message });
  }
};

// 主线程调用
const parseExcelInWorker = async (file: File) => {
  const worker = new Worker("/workers/excel-parser.js");
  return new Promise((resolve, reject) => {
    worker.postMessage({ file });
    worker.onmessage = (e) => {
      worker.terminate();
      e.data.success ? resolve(e.data.data) : reject(new Error(e.data.error));
    };
    worker.onerror = reject;
  });
};
```

### 2. 文件上传组件设计

#### 2.1 增强型上传组件

```typescript
interface FileUploadProps {
  accept: string[];
  maxSize: number;
  multiple?: boolean;
  onProgress?: (progress: number) => void;
  onError?: (error: string) => void;
  onSuccess?: (result: any) => void;
}

const EnhancedFileUpload: React.FC<FileUploadProps> = ({
  accept,
  maxSize,
  onProgress,
  onError,
  onSuccess,
}) => {
  // 拖拽上传支持
  // 文件验证
  // 进度显示
  // 错误处理
};
```

## API 接口设计

### 1. 现有 API 接口

```typescript
// 词典管理
POST   /api/custom-dictionaries          # 创建词典
GET    /api/custom-dictionaries          # 获取用户词典列表
GET    /api/custom-dictionaries/:id      # 获取词典详情
PUT    /api/custom-dictionaries/:id      # 更新词典信息
DELETE /api/custom-dictionaries/:id      # 删除词典

// 单词管理
POST   /api/custom-dictionaries/:id/words     # 批量添加单词
GET    /api/custom-dictionaries/:id/words     # 获取词典单词列表
PUT    /api/custom-dictionaries/:id/words/:wordId  # 更新单词
DELETE /api/custom-dictionaries/:id/words/:wordId  # 删除单词
```

## 安全与性能

### 1. 安全措施

```typescript
const securityConfig = {
  // 文件限制
  maxFileSize: 10 * 1024 * 1024, // 10MB

  // 内容限制
  maxWordsPerDictionary: 10000,
  maxDictionariesPerUser: 50,

  // 频率限制
  rateLimiting: {
    uploadsPerHour: 5,
    requestsPerMinute: 60,
  },

  // 内容过滤
  contentFiltering: {
    enableProfanityFilter: true,
    maxWordLength: 50,
    allowedCharacters: /^[a-zA-Z\s\-'\.]+$/,
  },
};
```

### 2. 性能优化策略

```typescript
// 缓存策略
interface CacheStrategy {
  userDictionaries: "persistent"; // IndexedDB持久化
  officialWords: "session"; // SessionStorage会话级
  enrichmentResults: "temporary"; // Memory临时缓存
  uploadProgress: "volatile"; // 不持久化
}
```

## 开发与维护指南

### 2. 测试策略

```typescript
// 重点测试领域
describe("Dictionary Upload Feature", () => {
  describe("Excel Parser", () => {
    test("should handle various Excel formats");
    test("should validate required fields");
    test("should handle large files efficiently");
    test("should process malformed data gracefully");
  });

  describe("File Upload", () => {
    test("should support drag and drop");
    test("should validate file size and type");
    test("should handle upload failures with retry");
    test("should show accurate progress");
  });

  describe("Data Processing", () => {
    test("should deduplicate words correctly");
    test("should enrich words from official library");
    test("should handle concurrent uploads");
    test("should maintain data consistency");
  });
});
```

### 3. 性能监控

```typescript
// 关键性能指标
interface PerformanceMetrics {
  fileParsingTime: number; // 文件解析耗时
  validationTime: number; // 数据验证耗时
  enrichmentTime: number; // 词汇补充耗时
  uploadTime: number; // 上传耗时
  memoryUsage: number; // 内存使用量
  errorRate: number; // 错误率
  userSatisfactionScore: number; // 用户满意度
}
```

## 总结与建议

### 优先级建议

1. **高优先级：** Web Worker 解析、性能优化

### 技术债务

- 考虑将 Excel 解析逻辑迁移到 Web Worker
- 优化大文件上传的内存使用
- 增强 API 的错误处理和重试机制
- 完善用户权限和数据隔离

### 未来发展方向

- 支持更多文件格式（CSV、JSON、TXT）
- 实现词典版本控制和协作编辑
- 集成 AI 辅助的词汇推荐和学习路径规划
- 开发移动端原生应用支持
