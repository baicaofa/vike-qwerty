### 项目通用规范文档（适用于 Vike + React + TypeScript + Dexie + MongoDB）

本规范为本项目统一的工程标准，覆盖目录与模块约定、数据与接口契约、开发与发布流程、安全、测试与监控等。所有新功能、修复、重构必须遵循本文档。

## 1. 目标与适用范围
- 统一编码与数据契约，降低协作成本与回归风险。
- 适用于前端（Vike/React/TS/Dexie）、后端（Express/Mongoose/MongoDB）、同步服务、脚本与文档。

## 2. 目录与模块约定
- 前端
  - 页面与路由：Vike file-based
    - 页面文件：`src/pages/**/+Page.tsx`
    - 页面配置：`+config.ts`、`+onBeforeRender.ts`、`+onPrerenderStart.ts`
  - 组件目录：`src/components/**`
  - 状态：`src/store/**`（Jotai/Zustand）
  - 工具/通用：`src/utils/**`（子域：`db`、`spaced-repetition`、`sounds`、`i18n` 等）
  - 静态资源：`src/assets/**`；国际化词条：`public/locales/**`
- 后端
  - 入口：`src/server/index.ts`
  - 模型：`src/server/models/**`
  - 控制器：`src/server/controllers/**`
  - 路由：`src/server/routes/**`
  - 中间件：`src/server/middleware/**`
  - 服务/脚本：`src/server/services/**`、`src/server/scripts/**`
- 文档：`doc/**`（设计、规范、SOP、ADR）

## 3. 命名与代码风格
- 命名：一律驼峰；禁止 snake_case（如 `syncStatus/lastModified/createTime`）
- TypeScript
  - 所有导出函数与公共 API 必须显式类型；避免 `any`
  - 避免深层嵌套；优先早返回与防御式编程
- 导入顺序：第三方→别名路径（`@/…`）→相对路径；使用 Prettier + ESLint 保持风格
- 提交信息：Conventional Commits（feat/fix/chore/docs/refactor/test/build/ci/revert）

## 4. 数据模型与类型（统一契约）
- 时间字段
  - 前端/接口：毫秒 `number`（UTC）
  - 后端/DB：`Date`
  - 转换只允许发生在“接口边界”
- 通用字段（服务端所有集合统一）
  - `uuid: string`（不可变）
  - `userId: ObjectId`
  - `syncStatus: "synced"|"localNew"|"localModified"|"localDeleted"`
  - `lastModified: number`（客户端最近修改时刻，毫秒）
  - `clientModifiedAt: Date`（由 `lastModified` 转换）
  - `isDeleted: boolean`（软删除）
  - `createdAt/updatedAt: Date`（Mongoose timestamps）
- 唯一与外键
  - wordRecords: `(userId, dict, word)` 唯一
  - wordReviewRecords: `(userId, word)` 唯一（跨词典聚合）
  - familiarWords: `(userId, dict, word)` 唯一
  - reviewHistories 外键：`parentUuid = wordReviewRecords.uuid`（严禁用 `word` 反查）

## 5. IndexedDB/Dexie 规范
- 版本治理：前端维护 `APP_DATA_VERSION` 哨兵；不匹配→重建或迁移
- 升级约束
  - 迁移在 `version(n).upgrade(tx=>…)` 中执行，分批（200–1000/批）
  - 升级互斥：多标签页升级锁（BroadcastChannel + localStorage）；升级中 UI 禁操作
  - 失败兜底：触发“冷启动重建”（仅本地）
- 表结构（示例）
  - `wordRecords: "++id,&uuid,&[dict+word],dict,word,lastPracticedAt,lastModified"`
- 运行时写入规则
  - upsert by `uuid`
  - `wordRecords.performanceHistory[*]` 必须包含 `entryUuid: string`，无错时 `mistakes = {}`
  - `familiarWords` 写入侧严格 upsert `[dict+word]`

## 6. 后端 Mongoose 规范
- Schema 定义统一通用字段（见第 4 节）
- `wordRecords.performanceHistory[*]`
  - `entryUuid: String`（必填）
  - `timeStamp: Date`
  - `mistakes: Mixed`（默认 `{}`）
- reviewHistories
  - DB 外键：`wordReviewRecordId: ObjectId`
  - 接口回传：`parentUuid`；隐藏 `ObjectId`
- 索引（示例）
  - wordRecords: `(userId, dict, word)` unique；`(userId, lastPracticedAt)`、`(userId, updatedAt)`
  - wordReviewRecords: `(userId, word)` unique；`(userId, nextReviewAt/lastReviewedAt/updatedAt)`
  - reviewHistories: `(userId, reviewedAt)`、`(userId, word, reviewedAt)`、`(userId, sessionId)`

## 7. 同步协议（/api/sync）
- 策略：先下后上；幂等 upsert by `uuid`；删除使用 `isDeleted=true`（软删）
- 冲突：`lastModified(ms)` vs `clientModifiedAt.getTime()` → 新者胜
- 历史合并（wordRecords）
  - 优先以 `entryUuid` 去重；回退 `(timeStamp + featureHash)`
- 字段白名单与校验：边界使用校验库（Zod/Joi）；拒绝未知字段
- 版本：请求头 `x-app-data-version` ≥ 最小版本（如 `v10`），否则 426/409

## 8. API 约定
- 授权：HttpOnly Cookie（`Secure` + `SameSite=Lax/Strict`）
- 响应结构
```json
{
  "success": true,
  "data": {},
  "error": null,
  "timestamp": 1731480000000
}
```
- 错误格式
```json
{
  "success": false,
  "error": { "code": "VALIDATION_ERROR", "message": "字段缺失" },
  "timestamp": 1731480000000
}
```
- 分页：`?page=1&pageSize=20&sortBy=updatedAt&sortOrder=desc`

## 9. 安全规范
- 认证：HttpOnly Cookie；过渡期可同时支持 Bearer（尽快移除）
- CSRF：同源 SPA 可用 `SameSite=Lax`；跨站场景启用双重提交 Token
- 输入与 DB 安全：字段白名单、类型校验；Mongoose sanitize（阻止 `$`/`.` 注入）
- 同步限流：限制 `changes` 数量与单条 payload 体积；请求频率限流

## 10. 测试策略
- 单元：数据转换（number↔Date）、entryUuid 合并、parentUuid 外键解析、mistakes 兜底
- 集成：先下后上；并发写入；旧端/新端混合
- 迁移：Dexie v10 升级（大数据、断电恢复、冷启动重建）
- 覆盖率：核心模块（同步控制器、数据合并）行/分支覆盖 ≥ 80%

## 11. 监控与告警
- 指标
  - 同步成功率、平均耗时、冲突裁决（client/server 胜）、外键失败率、版本拒写率、batch upsert 数
  - 迁移修复计数（去重/补默认值/兜底时间）
- 健康检查：`/healthz` 返回 DB 与队列状态
- 告警阈值：同步错误率 > 2%；外键失败率 > 0.1%

## 12. 发布与回滚
- 顺序：Mongo 索引 → 后端兼容新协议（版本拒写观测模式）→ 小流量前端 → 启用版本拒写 → 放量
- 灰度开关：`SYNC_PROTOCOL_V10_ENABLED`（可白名单/比例）
- 回滚：关闭开关→禁写新协议→保留只读→修复后再启用
- 缓存：所有构建产物文件名哈希；如有 SW，确保更新策略与强制刷新

## 13. 国际化与可访问性
- i18n：所有 UI 文案必须在 `public/locales/**`，禁止硬编码；键名有命名空间（如 `common.ok`）
- a11y：为交互元素提供 `aria-*` 与键盘操作；颜色对比遵循 WCAG AA

## 14. 性能指引
- 列表查询必须有索引支撑（避免全表扫描）
- Dexie 批量操作优先 `bulkPut/bulkDelete`；分页读取
- 大对象历史（`performanceHistory`）可做“老记录压缩/聚合”（保留最近 N 条）

## 15. 文档与评审清单
- 所有数据变更必须同步更新文档（字段表、索引、协议、迁移步骤）
- PR 审核必检
  - 是否遵循命名/类型规范？
  - 是否仅在边界转换时间类型？
  - 是否更新索引与校验白名单？
  - 是否遵守 entryUuid/parentUuid 约束？
  - 是否提供测试与文档？

## 16. 依赖与环境
- 依赖版本固定（lockfile）；每季度安全升级
- 环境变量：`.env` 仅本地；生产从安全密钥管理注入；严禁提交密钥

## 附：常用清单（可复制勾选）
- 新增字段
  - [ ] 驼峰命名
  - [ ] FE: number(ms) / BE: Date
  - [ ] 文档与类型已更新
- 新增表/索引
  - [ ] 唯一/二级索引已评审并创建
  - [ ] 同步控制器与校验白名单已更新
- 同步改动
  - [ ] 幂等 upsert by uuid
  - [ ] 冲突裁决规则保持一致
  - [ ] 历史合并按 entryUuid
- Dexie 迁移
  - [ ] 分批 + 锁 + 断点续迁
  - [ ] 失败兜底（冷启动重建）
- 安全
  - [ ] Cookie/CORS/CSRF 配置正确
  - [ ] 速率限制与体积限制启用
- 发布
  - [ ] 后端先行；灰度开关可回退
  - [ ] 监控指标上线与告警阈值设置

