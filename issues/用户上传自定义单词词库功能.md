# 用户上传自定义单词词库功能实现说明

- 项目技术栈：Vike、React、TypeScript、Tailwind CSS、Jotai/Zustand

## 功能目标

这个功能允许用户上传自己的词库文件（Excel 格式），创建个性化的单词书，用于英语打字练习。具体价值包括：

1. **个性化学习**：用户可以根据自己的学习需求和兴趣创建专属词库
2. **灵活性提升**：支持专业领域词汇、特定考试词汇等个性化需求
3. **提高用户粘性**：通过允许用户创建和管理自己的内容，增强用户与平台的连接
4. **扩大应用场景**：使应用不仅适用于标准词库学习，也适用于自定义内容学习

## 用户视角

### 完整流程

1. **进入词库管理页面**：

   - 用户在 Gallery 页面切换到"我的词典"标签
   - 未登录用户在使用上传词库功能时会被引导先登录或注册账号

2. **上传词库文件**：

   - 用户可以选择上传 Excel 格式的文件
   - 界面提供清晰的格式说明和模板下载选项
   - 上传弹窗提供详细的操作指引和格式要求

3. **预览与编辑**：

   - 上传后，系统解析文件并显示预览界面

   - 用户可以在预览界面修改词库名称、描述、分类和标签
   - 可以浏览词库内容，并对单词条目进行编辑、删除或添加

4. **格式验证与修正**：

   - 系统自动检查格式问题并提示（如缺少必要字段、格式错误等）
   - 提供手动修正界面
   - 数据去重，根据单词字段

5. **创建完成**：

   - 用户确认无误后点击"创建词库"按钮
   - 系统显示进度条和创建状态
   - 创建成功后，提示用户并自动跳转到词库详情页

6. **使用自定义词库**：
   - 自定义词库会出现在"我的词库"分类下
   - 用户可以像使用内置词库一样选择、练习自定义词库
   - 练习数据、错误统计等功能与内置词库保持一致

### 格式要求与实现

1. **支持的文件格式**：

   - Excel 文件(.xlsx, .xls)

2. **字段要求**：

   - 单词(word/name)：必须，英文单词或短语
   - 翻译(trans/translation)：可选，中文解释或翻译
   - 美式音标(usphone/phonetic)：可选
   - 英式音标(ukphone)：可选
   - 注释(notation)：可选

3. **错误处理**：
   - 文件格式错误：提示"不支持的文件格式，请上传 Excel 文件"
   - 内容解析错误：提示具体行号和错误原因
   - 字段缺失：提示"Excel 文件缺少必要的列: word/Word/单词"
   - 用户未登录：提示"请先登录后再上传词库"

## 前端实现

### 已实现的界面

1. **词库管理界面**：

   - 集成在 Gallery 页面的"我的词典"标签中
   - 显示用户的所有自定义词库列表
   - 提供"上传新词库"按钮

2. **词库上传弹窗**：

   - 作为 Modal 组件实现，无需单独的路由
   - 提供文件上传区域
   - 格式说明和模板下载链接
   - 上传进度显示
   - 实现去重逻辑，上传词库中若有重复单词，将保留第一条并忽略重复项
   - 忽略空行

3. **词库预览步骤**：

   - 作为上传弹窗的一部分实现
   - 词库基本信息编辑表单（名称、描述、分类、标签）
   - 单词列表预览
   - 错误提示和修正功能

4. **词库卡片**：
   - 在"我的词典"标签下展示
   - 显示词库名称、描述、标签和单词数量
   - 提供编辑、练习和删除按钮

### 已实现的组件

1. **UploadDictionaryModal**：

   - 支持 Excel 文件格式上传
   - 提供文件选择区域
   - 显示上传进度和状态
   - 实现分步骤上传流程（上传 → 预览 → 处理）

2. **Excel 解析功能**：

   - 使用 SheetJS/xlsx 库解析 Excel 文件
   - 处理各种编码和格式问题
   - 提供错误处理和修正功能

3. **CustomDictionaryList**：

   - 展示用户的自定义词典列表
   - 提供上传、编辑、练习和删除功能
   - 处理空状态展示

4. **词典适配器**：
   - 将自定义词典转换为应用内 Dictionary 格式
   - 支持在 Gallery 页面和打字练习页面使用自定义词典

### 已修改的文件

1. **Gallery 页面组件**：

   - 修改`src/pages/gallery/+Page.tsx`，添加自定义词典标签处理逻辑
   - 修改`src/pages/gallery/LanguageTabSwitcher.tsx`，添加"我的词典"选项
   - 添加`src/pages/gallery/context.ts`，增加上传弹窗状态管理

2. **全局状态管理**：

   - 添加`src/store/customDictionary.ts`，实现自定义词典状态管理
   - 实现词典适配器，将自定义词典转换为通用格式

3. **API 和服务**：
   - 添加`src/hooks/useCustomDictionary.ts`，封装自定义词典 API 调用
   - 添加`src/services/customDictionaryService.ts`，实现与后端的交互
   - 添加`src/utils/excelParser.ts`，实现 Excel 文件解析功能

## 后端实现

### 数据库设计

1. **自定义词库表**：

```typescript
interface CustomDictionary {
  id: string; // 唯一标识符
  userId: string; // 关联用户ID
  name: string; // 词库名称
  description: string; // 词库描述
  category: string; // 词库分类
  tags: string[]; // 词库标签
  length: number; // 单词数量
  language: string; // 语言类型
  languageCategory: string; // 语言分类
  createdAt: number; // 创建时间
  updatedAt: number; // 更新时间
  isPublic: boolean; // 是否公开
  version: number; // 版本号
}
```

2. **自定义词库单词表**：

```typescript
interface CustomWord {
  id: string; // 唯一标识符
  dictId: string; // 关联词库ID
  name: string; // 单词
  trans?: string[]; // 翻译
  usphone?: string; // 美式音标
  ukphone?: string; // 英式音标
  notation?: string; // 注释
  index: number; // 在词库中的索引位置
}
```

3. **数据库索引**：

   - 为 `CustomWord` 表创建索引，优化查询性能：

     ```typescript
     // 对dictId创建索引，加速按词库查询单词
     customWords.createIndex("dictId", "dictId");

     // 对name创建索引，支持单词搜索功能
     customWords.createIndex("name", "name");

     // 对dictId和name创建复合索引，优化特定词库内的单词查询
     customWords.createIndex("dictId_name", ["dictId", "name"]);
     ```

   - 这些索引对于处理大型词库（成千上万词条）时尤为重要，能显著提高查询效率

### 已实现的 API

1. **词库管理 API**：

   - `POST /api/custom-dictionaries`：创建新词库
   - `GET /api/custom-dictionaries`：获取用户词库列表
   - `GET /api/custom-dictionaries/:id`：获取词库详情
   - `PUT /api/custom-dictionaries/:id`：更新词库信息
   - `DELETE /api/custom-dictionaries/:id`：删除词库

2. **单词管理 API**：
   - `POST /api/custom-dictionaries/:id/words`：批量添加单词
   - `GET /api/custom-dictionaries/:id/words`：获取词库单词列表
     - 支持分页参数：`?page=1&pageSize=20`
   - `PUT /api/custom-dictionaries/:id/words/:wordId`：更新单词
   - `DELETE /api/custom-dictionaries/:id/words/:wordId`：删除单词

### 存储方案

1. **云端存储**：
   - 已登录用户的自定义词库存储在服务器数据库中
   - 支持跨设备访问

## 边界条件处理

### 已实现的异常处理

1. **格式验证**：

   - 实现了 Excel 文件格式验证
   - 提供清晰的错误提示和行号指示
   - 在上传弹窗中显示详细的错误信息

2. **用户认证**：

   - 要求用户必须登录才能上传词库
   - 在上传过程中验证用户登录状态

3. **数据处理**：
   - 自动过滤空行和无效内容
   - 自动去重处理，避免重复单词
   - 验证必要字段存在（如单词字段）

### 安全措施

1. **文件类型验证**：

   - 前端验证文件扩展名和 MIME 类型
   - 解析过程中验证文件内容格式

2. **用户权限控制**：
   - 确保用户只能访问和修改自己的词库
   - API 请求中包含身份验证令牌

## 已实现功能总结

### 基础功能

1. **自定义词库上传**：

   - 支持 Excel 文件上传和解析
   - 自动处理格式验证和数据清理
   - 支持词库元数据编辑（名称、描述、标签等）

2. **词库管理**：

   - 在 Gallery 页面"我的词典"标签下展示所有自定义词库
   - 支持词库编辑、删除和练习操作
   - 提供清晰的空状态提示和上传引导

3. **词库练习**：
   - 自定义词库可以像内置词库一样用于打字练习
   - 通过适配器将自定义词库转换为应用通用格式

### 技术实现

1. **文件解析**：

   - 使用 SheetJS/xlsx 库处理 Excel 文件
   - 实现客户端文件解析，减轻服务器负担
   - 提供详细的错误处理和反馈

2. **前端实现**：

   - 使用 React 组件和 Tailwind CSS 构建用户界面
   - 使用 Modal 组件实现上传弹窗，避免额外的路由跳转
   - 使用 Jotai 管理全局状态

3. **API 集成**：
   - 实现完整的 CRUD API 调用
   - 使用自定义 Hook 封装 API 逻辑
   - 实现适配器模式转换数据格式

## 未来可能的扩展

1. **词库共享功能**：

   - 允许用户将自己的词库设为公开
   - 支持用户复制他人共享的词库

2. **高级编辑功能**：

   - 提供更完善的在线词库编辑功能
   - 支持从零创建新词库

3. **数据分析功能**：
   - 为自定义词库提供学习数据分析
   - 生成学习进度报告和错误分析

## 数据流转与集成

### 词典适配器实现

已实现自定义词典适配器，将自定义词典转换为应用内通用格式：

```typescript
export function adaptCustomDictionaryToDictionary(
  customDict: ICustomDictionary
): Dictionary {
  return {
    id: `custom_${customDict.id}`, // 添加前缀区分自定义词库
    name: customDict.name,
    description: customDict.description,
    category: customDict.category || "我的词库", // 默认分类
    tags: customDict.tags,
    // 特殊URL格式，表示从API加载
    url: `api://custom-dictionaries/${customDict.id}`,
    length: customDict.length,
    language: customDict.language || "en",
    languageCategory: customDict.languageCategory || "en",
    chapterCount: Math.ceil(customDict.length / 20), // 每章20个单词
  };
}
```

### 词库加载与展示

在 Gallery 页面实现了条件渲染，根据当前选择的语言标签显示不同内容：

```tsx
{
  galleryState.currentLanguageTab === "my-dict" ? (
    <CustomDictionaryList onOpenUploadModal={handleOpenUploadModal} />
  ) : (
    <div className="mr-4 flex flex-1 flex-col items-start justify-start gap-14 overflow-y-auto">
      {groupedByCategoryAndTag.map(([category, groupeByTag]) => (
        <DictionaryGroup key={category} groupedDictsByTag={groupeByTag} />
      ))}
    </div>
  );
}
```

### 自定义词库卡片

自定义词库卡片包含了管理按钮，便于用户进行操作：

```tsx
<div className="flex justify-end border-t border-gray-200 p-2 dark:border-gray-800">
  <Button
    variant="outline"
    size="sm"
    className="mr-2"
    onClick={() => navigate(`/gallery/custom_${dictionary.id}/edit`)}
  >
    编辑
  </Button>
  <Button
    variant="outline"
    size="sm"
    className="mr-2"
    onClick={() => handlePracticeClick(dictionary.id)}
  >
    练习
  </Button>
  <Button
    variant="outline"
    size="sm"
    className="text-red-600 hover:bg-red-50 dark:text-red-400 dark:hover:bg-red-950/30"
    onClick={() => handleDeleteDictionary(dictionary)}
  >
    删除
  </Button>
</div>
```
