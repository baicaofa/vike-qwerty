# 用户上传自定义单词词库功能设计方案

## 项目概述

为应用添加用户上传自定义单词词库功能，允许用户创建、编辑、导入、共享和同步自定义词库，丰富应用的个性化学习体验。

## 核心功能

1. **多格式词库导入**：支持 CSV、JSON、Excel、纯文本和 Anki 格式
2. **完整的词库编辑**：包括词库信息和单词内容的编辑功能
3. **词库共享系统**：允许用户分享和订阅词库
4. **跨设备同步**：支持用户在多设备间同步自定义词库
5. **与现有系统集成**：自定义词库可以像内置词库一样使用

## 详细设计

### 1. 数据模型设计

#### 1.1 自定义词库模型

```typescript
interface CustomDictionary {
  id?: number; // 数据库自增ID
  uuid: string; // 全局唯一标识符
  userId?: string; // 关联用户ID（登录用户）
  name: string; // 词库名称
  description: string; // 词库描述
  category: string; // 词库分类
  tags: string[]; // 词库标签
  createdAt: number; // 创建时间
  lastModifiedAt: number; // 最后修改时间
  wordCount: number; // 单词数量
  language: LanguageType; // 语言类型
  languageCategory: LanguageCategoryType; // 语言分类
  isPublic: boolean; // 是否公开分享
  shareCode?: string; // 分享码
  sourceUrl?: string; // 来源URL
  version: number; // 版本号
  sync_status: SyncStatus; // 同步状态
  clientModifiedAt?: number; // 客户端修改时间
  serverModifiedAt?: number; // 服务器修改时间
  isDeleted?: boolean; // 是否已删除
}
```

#### 1.2 自定义词库单词模型

```typescript
interface CustomWord {
  id?: number; // 数据库自增ID
  uuid: string; // 全局唯一标识符
  dictId: number; // 关联词库ID
  dictUuid: string; // 关联词库UUID
  name: string; // 单词名称
  trans: string[]; // 翻译
  usphone?: string; // 美式音标
  ukphone?: string; // 英式音标
  notation?: string; // 注释
  examples?: string[]; // 例句
  synonyms?: string[]; // 同义词
  antonyms?: string[]; // 反义词
  createdAt: number; // 创建时间
  lastModifiedAt: number; // 最后修改时间
  sync_status: SyncStatus; // 同步状态
  clientModifiedAt?: number; // 客户端修改时间
  serverModifiedAt?: number; // 服务器修改时间
  isDeleted?: boolean; // 是否已删除
}
```

### 2. 数据库扩展

#### 2.1 客户端数据库扩展

```typescript
// 在 RecordDB 类中添加新表
this.version(7).stores({
  // 现有表结构...

  // 自定义词库表
  customDictionaries:
    "++id, &uuid, userId, name, category, language, createdAt, lastModifiedAt, isPublic, version, sync_status",

  // 自定义词库单词表
  customWords:
    "++id, &uuid, dictId, dictUuid, name, [dictId+name], [dictUuid+name], createdAt, lastModifiedAt, sync_status",
});
```

#### 2.2 服务器端数据库模型

```typescript
// CustomDictionary 模型
const CustomDictionarySchema = new mongoose.Schema(
  {
    uuid: { type: String, required: true, unique: true, index: true },
    userId: {
      type: mongoose.Schema.Types.ObjectId,
      ref: "User",
      required: true,
      index: true,
    },
    name: { type: String, required: true },
    description: { type: String },
    category: { type: String, required: true },
    tags: [String],
    wordCount: { type: Number, default: 0 },
    language: { type: String, required: true },
    languageCategory: { type: String, required: true },
    isPublic: { type: Boolean, default: false },
    shareCode: { type: String, sparse: true, index: true },
    sourceUrl: { type: String },
    version: { type: Number, default: 1 },
    sync_status: { type: String, default: "synced" },
    clientModifiedAt: { type: Date, required: true },
    serverModifiedAt: { type: Date, required: true },
    isDeleted: { type: Boolean, default: false, index: true },
  },
  { timestamps: true }
);

// CustomWord 模型
const CustomWordSchema = new mongoose.Schema(
  {
    uuid: { type: String, required: true, unique: true, index: true },
    dictUuid: { type: String, required: true, index: true },
    userId: {
      type: mongoose.Schema.Types.ObjectId,
      ref: "User",
      required: true,
      index: true,
    },
    name: { type: String, required: true },
    trans: [String],
    usphone: String,
    ukphone: String,
    notation: String,
    examples: [String],
    synonyms: [String],
    antonyms: [String],
    sync_status: { type: String, default: "synced" },
    clientModifiedAt: { type: Date, required: true },
    serverModifiedAt: { type: Date, required: true },
    isDeleted: { type: Boolean, default: false, index: true },
  },
  { timestamps: true }
);

// 添加复合索引
CustomDictionarySchema.index({ userId: 1, name: 1 }, { unique: true });
CustomWordSchema.index({ dictUuid: 1, name: 1 }, { unique: true });
```

### 3. 文件导入功能

#### 3.1 支持的文件格式

- CSV（逗号分隔值）
- JSON（标准格式）
- Excel（.xlsx, .xls）
- 纯文本（按行分隔）
- Anki 导出格式（.apkg）

#### 3.2 导入流程

1. 文件选择与验证
2. 格式检测与解析
3. 字段映射配置
4. 数据预览与编辑
5. 导入确认
6. 处理与保存

#### 3.3 字段映射配置

- 必选字段：单词(name)、翻译(trans)
- 可选字段：美式音标(usphone)、英式音标(ukphone)、注释(notation)、例句(examples)、同义词(synonyms)、反义词(antonyms)

### 4. 词库编辑功能

#### 4.1 词库信息编辑

- 基本信息：名称、描述、分类、标签
- 共享设置：是否公开、分享码
- 语言设置：语言类型、语言分类

#### 4.2 单词管理

- 单词列表（分页、排序、筛选）
- 单词添加/编辑/删除
- 批量操作（导入、导出、删除）
- 单词搜索

#### 4.3 高级编辑功能

- 音标编辑器（支持国际音标符号）
- 例句管理
- 同/反义词关联
- 单词分类和标签

### 5. 词库共享系统

#### 5.1 共享设置

- 公开/私有控制
- 分享码生成
- 分享链接生成
- 访问权限管理

#### 5.2 词库发现

- 公开词库浏览
- 分类和标签筛选
- 热门和推荐词库
- 搜索功能

#### 5.3 词库订阅

- 订阅公开词库
- 接收更新通知
- 自动同步更新

### 6. 同步系统

#### 6.1 同步机制

- 本地优先策略
- 增量同步
- 版本控制
- 冲突检测与解决

#### 6.2 同步 API

- 获取更新：`GET /api/custom-dictionaries/sync`
- 提交更改：`POST /api/custom-dictionaries/sync`
- 解决冲突：`PUT /api/custom-dictionaries/resolve-conflict`

#### 6.3 离线支持

- 本地缓存
- 队列化同步请求
- 网络恢复自动同步

### 7. 用户界面设计

#### 7.1 词库管理页面

- 词库列表视图
- 创建/导入词库入口
- 词库操作菜单
- 筛选和排序控件

#### 7.2 词库详情页面

- 词库信息展示
- 单词列表
- 练习入口
- 编辑和共享控件

#### 7.3 导入向导

- 多步骤引导界面
- 文件上传区域
- 字段映射配置
- 预览和确认区域

#### 7.4 词库编辑器

- 词库信息表单
- 单词表格视图
- 单词编辑表单
- 批量操作工具栏

#### 7.5 共享和发现页面

- 公开词库浏览界面
- 分类和标签导航
- 搜索和筛选控件
- 订阅管理界面

## 实施计划

### 阶段一：基础架构（2 周）

1. 设计并实现数据模型
2. 扩展客户端数据库
3. 创建基本的数据访问函数
4. 搭建词库管理页面框架

### 阶段二：导入功能（2 周）

1. 实现 CSV 和 JSON 解析
2. 开发字段映射界面
3. 创建导入向导流程
4. 添加数据验证和错误处理

### 阶段三：词库编辑（2 周）

1. 开发词库信息编辑界面
2. 实现单词列表和编辑功能
3. 添加批量操作功能
4. 创建音标编辑器

### 阶段四：服务器端支持（2 周）

1. 设计并实现服务器端模型
2. 开发同步 API
3. 实现用户认证和授权
4. 添加数据验证和安全措施

### 阶段五：共享系统（2 周）

1. 实现词库共享设置
2. 开发公开词库浏览界面
3. 创建词库订阅机制
4. 添加评分和评论功能

### 阶段六：高级功能和优化（2 周）

1. 实现 Excel 和 Anki 格式支持
2. 添加高级搜索和筛选功能
3. 优化离线支持和同步性能
4. 进行用户测试和反馈收集

### 阶段七：测试和发布（1 周）

1. 进行全面的功能测试
2. 修复发现的问题
3. 编写用户文档
4. 准备发布

## 预期成果

1. 一个功能完整的自定义词库管理系统
2. 支持多种格式的词库导入功能
3. 直观易用的词库编辑器
4. 词库共享和发现平台
5. 可靠的跨设备同步机制
6. 与现有系统无缝集成的用户体验

## 风险和缓解措施

1. **数据同步冲突**

   - 实施严格的版本控制
   - 提供明确的冲突解决机制
   - 保留操作历史记录

2. **性能问题**

   - 实现分页和懒加载
   - 优化数据库查询
   - 使用缓存减少重复请求

3. **用户体验一致性**

   - 遵循现有系统的设计语言
   - 确保与现有功能的无缝集成
   - 进行用户测试和反馈收集

4. **数据安全**
   - 实施适当的访问控制
   - 验证所有用户输入
   - 定期备份用户数据

## 后续建议

1. 考虑建立词库质量评估机制，确保共享词库的质量
2. 探索 AI 辅助功能，如自动生成例句或相关词推荐
3. 开发词库使用数据分析功能，帮助用户了解学习效果
4. 考虑与第三方词典 API 集成，丰富单词信息
