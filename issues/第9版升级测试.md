# 第 9 版数据库升级测试

## 测试目标

验证简化后的第 9 版数据库升级逻辑是否正常工作，确保：

1. 新表结构正确创建
2. 默认配置正确初始化
3. 升级状态管理正常
4. 复习系统能正常开始工作

## 测试步骤

### 1. 升级前检查

```javascript
// 在浏览器控制台执行
console.log("当前数据库版本:", db.verno);
console.log(
  "表列表:",
  db.tables.map((t) => t.name)
);
```

### 2. 触发升级

```javascript
// 强制触发升级
import { checkAndUpgradeDatabase } from "@/utils/db";

const result = await checkAndUpgradeDatabase();
console.log("升级结果:", result);
```

### 3. 升级后验证

```javascript
// 检查新表是否创建
console.log("升级后版本:", db.verno);
console.log("新表检查:");
console.log("- wordReviewRecords:", await db.wordReviewRecords.count());
console.log("- reviewHistories:", await db.reviewHistories.count());
console.log("- reviewConfigs:", await db.reviewConfigs.count());

// 检查默认配置
const config = await db.reviewConfigs.toArray();
console.log("默认配置:", config[0]);
```

### 4. 测试复习功能

```javascript
// 测试练习同步到复习系统
import { syncWordPracticeToReview } from "@/utils/spaced-repetition/scheduleGenerator";

await syncWordPracticeToReview("test", "test-dict", {
  isCorrect: true,
  responseTime: 2000,
  timestamp: Date.now(),
});

// 检查是否创建了复习记录
const reviewRecord = await db.wordReviewRecords
  .where("word")
  .equals("test")
  .first();
console.log("复习记录:", reviewRecord);
```

## 预期结果

### 升级成功标志

- 数据库版本升级到 9
- 创建了 3 个新表：wordReviewRecords, reviewHistories, reviewConfigs
- reviewConfigs 表包含 1 条默认配置记录
- 升级状态标记为 'completed'

### 功能验证

- 练习单词时能自动创建 WordReviewRecord
- 复习记录包含正确的字段和默认值
- 不会迁移历史数据，表从空开始

## 回滚测试

如果需要测试回滚：

```javascript
// 重置数据库
import { resetDatabase } from "@/utils/db";

await resetDatabase();
// 重新加载页面测试升级
```

## 注意事项

1. 升级过程中不会处理历史数据
2. 复习系统从用户开始使用时才开始记录
3. 升级应该很快完成（< 1 秒）
4. 不应该有任何数据丢失
